"use strict";new Vue({el:"#expendApproval",data:function(){return{approveToggle:!1,rejectToggle:!1,disabled:!0,comment:"",disable:!1,appDisable:!1,rejectDisable:!1,nextActorDisabled:!1,uploadFile:!1,uploaderFile:[],comments:!0,nextActors:!0,submit:!0,approveDia:!1,rejectDia:!1,submitDia:!1,avatar:"",remand:300,readonly:!0,expendList:{expenseType:"",expenseReason:"",totalAmount:"",creator:"",expenseMemos:"",comment:"",nextActor:"",processStateContext:{todoer:"",nextActorId:"",nextActorName:"",functionIds:""}},adminInfo:[],expend:[],fileList2:[],rule:{comment:[{required:!0,message:"请输入审批说明",trigger:"blur"}],nextActor:[{required:!0,message:"请选择下一步审批人",trigger:"change"}]}}},mounted:function(){var e=this;this.$nextTick(function(){e.fetchData()})},methods:{fetchData:function(){var e=sessionStorage.getItem("expenseId"),t=this;t.uploaderFile=JSON.parse(localStorage.getItem("file")),!1===t.submitDia&&(t.rule.nextActor[0].required=!1),axios.get("/api/v1/user").then(function(e){null===e.data.data.avatar?t.avatar="/dist/images/logo/logo.png":t.avatar=e.data.data.avatar}).catch(function(e){console.log(e)}),axios.get("/api/v1/funds/expenseform/"+e,{params:{entityId:e}}).then(function(e){t.expendList.expenseType=e.data.data.expenseType,t.expendList.expenseReason=e.data.data.expenseReason,t.expendList.totalAmount=(e.data.data.totalAmount/100).toFixed(2),t.expendList.expenseMemos=e.data.data.expenseMemos,t.expendList.creator=e.data.data.creator,t.expendList.processStateContext.todoer=e.data.data.processStateContext.todoer,t.expendList.processStateContext.functionIds=e.data.data.processStateContext.functionIds,t.adminInfo=e.data.data.formComments,e.data.data.formComments.forEach(function(e,o,s){t.adminInfo[o].created=new Date(s[o].created).Format("yyyy-MM-dd hh:mm")}),null!==e.data.data.processStateContext.nextActorId?(t.expendList.nextActor=e.data.data.processStateContext.nextActorId,t.nextActorDisabled=!0):(t.expendList.nextActor="",t.nextActorDisabled=!1),!0===e.data.data.processStateContext.todoer?(!0===e.data.data.processStateContext.endActivity?(t.nextActors=!1,t.submit=!1):(t.nextActors=!0,t.submit=!0),t.comments=!0,null===t.expendList.processStateContext.functionIds?(t.approveToggle=!1,t.rejectToggle=!1):(t.expendList.processStateContext.functionIds.indexOf("reject")>-1&&(t.rejectToggle=!0),t.expendList.processStateContext.functionIds.indexOf("approval")>-1&&(t.approveToggle=!0))):(t.nextActors=!1,t.comments=!1,t.approveToggle=!1,t.rejectToggle=!1,t.submit=!1)}).catch(function(e){console.log(e)}),axios.get("/api/v1/shop/employees").then(function(e){t.expend=e.data.data}).catch(function(e){console.log(e)})},saveExpenseList:function(e){var t=this;t.$refs[e].validate(function(e){e&&(t.submitDia=!0)})},approve:function(e){var t=this;t.$refs[e].validate(function(e){e&&(t.approveDia=!0)})},reject:function(e){var t=this;t.$refs[e].validate(function(e){e&&(t.rejectDia=!0)})},approveSure:function(){var e=this,t=sessionStorage.getItem("expenseId");sessionStorage&&sessionStorage.setItem("comment",e.expendList.comment);var o=sessionStorage.getItem("comment");axios({method:"post",url:"/api/v1/funds/expenseform/"+t+"/approve",params:{comment:o}}).then(function(t){e.$message({message:"已批准",type:"success"}),e.appDisable=!0,e.disable=!0,e.rejectDisable=!0,setTimeout(function(){window.location.href="/shop/expenseProcessForm"},3e3),e.approveDia=!1}).catch(function(e){console.log(e)})},rejectSure:function(){var e=this,t=sessionStorage.getItem("expenseId");sessionStorage&&sessionStorage.setItem("comment",e.expendList.comment);var o=sessionStorage.getItem("comment");axios({method:"post",url:"/api/v1/funds/expenseform/"+t+"/reject",params:{comment:o}}).then(function(t){e.$message({message:"已驳回",type:"success"}),e.disable=!0,e.appDisable=!0,e.rejectDisable=!0,setTimeout(function(){window.location.href="/shop/expenseProcessForm"},3e3),e.rejectDia=!1}).catch(function(e){console.log(e)})},submitSure:function(){var e=this,t=sessionStorage.getItem("expenseId");sessionStorage&&(sessionStorage.setItem("nextActorIds",e.expendList.nextActor),sessionStorage.setItem("comment",e.expendList.comment));var o=sessionStorage.getItem("nextActorIds"),s=sessionStorage.getItem("comment");axios({method:"post",url:"/api/v1/funds/expenseform/"+t+"/signal",params:{nextActorId:o,comment:s}}).then(function(t){e.$message({message:"提交成功",type:"success"}),e.disable=!0,e.appDisable=!0,e.rejectDisable=!0,setTimeout(function(){window.location.href="/shop/expenseProcessForm"},3e3),e.submitDia=!1}).catch(function(e){console.log(e)})},maxLen:function(){var e=this.expendList.comment.length;if(this.remand=300-e,e>300)return this.remand=0,!1}}});