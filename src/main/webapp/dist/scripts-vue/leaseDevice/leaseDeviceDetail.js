"use strict";var vm=new Vue({el:"#equipDetail",data:function(){return{activeName:"支出明细",type:"所有类型",product:"所有产品",city:"所有地区",detailBtn:"",isFocus1:!1,isFocus:!1,active:"基本信息",equipInfoShade:!1,imgSrc:"",filterTotal:0,filterReplace:0,padding:{padding:"10px"},deviceLogPage:{current:1,size:4},totalElements:0,moreText:"查看更多",isBlue:!1,moreIcon:!0,isNull:!1,noFilterDetails:!1,filterDetails:!0,iotpStatus:"",iotpStatusDetail:"",reminder:!1,estimatedDays:"",dialogVisible:!1,maintain:!1,modal:!1,modalBody:!1,onoff:!1,successAnimate:!1,noData:!1,waterRecordBtn:"周",waterDate:"",equipStateToggle:!1,_chart:null,dateSize:"tiny",orders:{},deviceLog:[{createdAt:"2017-06-19",logContext:"是不是很好"},{createdAt:"2017-06-19",logContext:"是不是很好"},{createdAt:"2017-06-19",logContext:"是不是很好"},{createdAt:"2017-06-19",logContext:"是不是很好"},{createdAt:"2017-06-19",logContext:"是不是很好"}],waterData:[],openoffBtn:[{name:"开/关机",value:"onoff"},{name:"一键冲洗",value:"flush"},{name:"恢复出厂设置",value:"restore"}],dataTypes:[{label:"周",type:"周"},{label:"月",type:"月"},{label:"年",type:"年"}],pageArray:{total:0,current:1,size:10,fisrtPage:0,lastPage:0},iotpStatuseImg:{lixian:!1,off:!1,noWater:!1,leak:!1,sensor:!1},equipDetail:[{text:"总用水量",key:"",style:"blueBox",unit:"L"},{text:"日均用水量",key:"",style:"cambridgeBlueBox",unit:"L"},{text:"TDS值",key:"",style:"greenBox",unit:""}],equipInfoDetail:[{title:"租赁产品名称",name:"",href:"javascript:",style:"blueColor"},{title:"产品设备型号",name:"",href:"javascript:",style:"blueColor"},{title:"设备编号",name:"",href:"javascript:"},{title:"客户姓名",name:"",href:"javascript:"},{title:"安装地址",name:"",href:"javascript:"},{title:"租赁单号",name:"",href:"",style:"blueColor"},{title:"起租日期",name:"",href:"javascript:"},{title:"到期日期",name:"",style:"redColor",href:"javascript:"}],equipDetailTab:[{label:"支出明细",name:"支出明细"},{label:"待审批支出",name:"待审批支出"},{label:"服务商提现申请",name:"服务商提现申请"}],equipData:[{label:"基本信息",name:"基本信息"},{label:"服务记录",name:"服务记录"},{label:"充值记录",name:"充值记录"},{label:"数据报表",name:"数据报表"}],rechargeTit:[{prop:"orderId",width:"",type:"",label:"充值单号"},{prop:"summary",width:"",type:"",label:"充值套餐"},{prop:"totalAmount",width:"",type:"",label:"充值金额(元)"},{prop:"leaseEndDate",width:"",type:"",label:"租赁到期日期"},{prop:"paidAt",width:"",type:"",label:"充值时间"}],seviceTit:[{prop:"select",width:"50",type:"selection",label:""},{prop:"status",width:"",type:"",label:"进度状态"},{prop:"shopServiceName",width:"",type:"",label:"服务类型"},{prop:"orderId",width:"",type:"",label:"服务单号"},{prop:"serviceVendor",width:"",type:"",label:"服务商"},{prop:"contactName",width:"",type:"",label:"客户姓名"},{prop:"serviceDate",width:"",type:"",label:"预约时间"},{prop:"created",width:"",type:"",label:"创建时间"}],filterData:[],serviceData:[],rechargeData:[],statement:[],waterRecord:[]}},created:function(){var e=this;this.$nextTick(function(){e.detail()})},mounted:function(){var e=this;this.$nextTick(function(){e.serviceTableTit(),e.rechargeTableTit()})},methods:{detail:function(){var e=this,a=sessionStorage.getItem("id"),t=sessionStorage.getItem("leaseProductId"),r=sessionStorage.getItem("productId");axios.get("/api/v1/lease/devices/"+a).then(function(a){!1===a.data.data.iotDevice.online?e.equipInfoShade=!0:e.equipInfoShade=!1,""===a.data.data.alertInfo?e.equipStateToggle=!1:e.equipStateToggle=!0,e.iotpStatus=a.data.data.alertInfo,e.imgSrc=a.data.data.productImage,e.equipInfoDetail[0].name=a.data.data.leaseProductName,e.equipInfoDetail[1].name=a.data.data.itemCode,null!==a.data.data.iotDevice.deviceMac?e.equipInfoDetail[2].name=a.data.data.deviceId+"("+a.data.data.iotDevice.deviceMac.toUpperCase()+")":e.equipInfoDetail[2].name="(未知)",""===a.data.data.lessee?e.equipInfoDetail[3].name=a.data.data.lesseeMobile:e.equipInfoDetail[3].name=a.data.data.lessee,null===a.data.data.address?e.equipInfoDetail[4].name="(未知)":e.equipInfoDetail[4].name=a.data.data.address.fullAddress,null===a.data.data.leaseOrderId?e.equipInfoDetail[5].name="(未知)":e.equipInfoDetail[5].name=a.data.data.leaseOrderId,e.equipInfoDetail[5].href=a.data.data.leaseOrderUrl,e.equipInfoDetail[6].name=new Date(a.data.data.leaseStartDate).Format("yyyy-MM-dd"),e.equipInfoDetail[7].name=new Date(a.data.data.leaseDueDate).Format("yyyy-MM-dd"),e.equipInfoDetail[0].href="/lease/product/"+t,e.equipInfoDetail[1].href="/shop/product/"+r,e.equipDetail[0].key=a.data.data.iotDevice.outWaterTotalFlow/1e3,e.equipDetail[1].key=a.data.data.iotDevice.outWaterTodayFlow/1e3,e.equipDetail[2].key=a.data.data.iotDevice.outWaterTds,null!==a.data.data.iotDevice.parts?(e.noFilterDetails=!1,e.filterDetails=!0,a.data.data.iotDevice.parts.forEach(function(a,t,r){e.filterData.push(r[t]),e.filterTotal=e.filterData.length,-1===r[t].estimatedDays&&(e.filterData[t].estimatedDays="估算中...");var i=e.filterData.filter(function(e){return e.availablePercentage<=5});e.filterReplace=i.length})):(e.noFilterDetails=!0,e.filterDetails=!1)}),axios.get("/api/v1/lease/devices/"+a+"/serviceOrders").then(function(a){e.serviceData=a.data.data;for(var t in a.data.data){if(isNaN(parseInt(t)))return!1;var r=new Date(a.data.data[t].serviceDate),i=new Date(a.data.data[t].created);switch(""===e.serviceData[t].serviceDate&&""===e.serviceData[t].created||(e.serviceData[t].serviceDate=r.Format("yyyy-MM-dd"),e.serviceData[t].created=i.Format("yyyy-MM-dd")),a.data.data[t].status){case 0:case 10:case 15:e.serviceData[t].status="待分派";break;case 20:e.serviceData[t].status="已分派";break;case 40:e.serviceData[t].status="待计价";break;case 41:e.serviceData[t].status="进行中";break;case 45:e.serviceData[t].status="已付款";break;case 60:e.serviceData[t].status="待付款";break;case 65:e.serviceData[t].status="已付款，待确认";break;case 70:e.serviceData[t].status="待评价";break;case 80:e.serviceData[t].status="已完成";break;case 85:e.serviceData[t].status="已取消，待确认";break;case 90:e.serviceData[t].status="已取消";break;case 92:e.serviceData[t].status="待退款";break;case 95:e.serviceData[t].status="厂商已拒绝"}}}),axios.get("/api/v1/lease/devices/"+a+"/rechargeOrders").then(function(a){e.rechargeData=a.data.data;for(var t in a.data.data){if(isNaN(parseInt(t)))return;var r=new Date(a.data.data[t].paidAt),i=new Date(a.data.data[t].leaseEndDate);""===e.rechargeData[t].paidAt&&""===e.rechargeData[t].leaseEndDate||(e.rechargeData[t].paidAt=r.Format("yyyy-MM-dd hh:mm:ss"),e.rechargeData[t].leaseEndDate=i.Format("yyyy-MM-dd")),e.rechargeData[t].totalAmount;var s=e.rechargeData[t].totalAmount/100;e.rechargeData[t].totalAmount=s.toFixed(2)}}),screen.width<1199&&(e.dateSize="small"),this.getWaterRecord(),this.deviceLogs(),this.charts()},getPartProductId:function(e){sessionStorage&&(sessionStorage.setItem("partProductId",this.filterData[e].partProductId),sessionStorage.getItem("partProductId"))},restoration:function(e){var a=this,t=sessionStorage.getItem("id");sessionStorage.setItem("filterIndex",e);var r=sessionStorage.getItem("filterIndex");axios.post("/api/v1/lease/devices/"+t+"/resetFilter/"+r).then(function(t){a.filterData[e].availablePercentage=t.data.data.availablePercentage,a.filterData[e].partProductImage=t.data.data.partProductImage,a.filterData[e].name=t.data.data.name,a.filterData[e].installedAt=t.data.data.installedAt,a.filterTotal=a.filterData.length,-1===t.data.data.estimatedDays&&(a.filterData[e].estimatedDays="估算中..."),a.$message({message:"复位成功",type:"success"})}).catch(function(e){console.log(e)})},getWaterRecord:function(){var e=this,a=sessionStorage.getItem("id");axios.get("/api/v1/lease/devices/"+a+"/datanodes",{params:{current:this.pageArray.current,rowCount:this.pageArray.size,"sort[startTime]":"desc"}}).then(function(a){e.pageArray.total=a.data.data.totalElements,e.waterRecord=a.data.data.fileList,e.waterRecord.length<e.pageArray.size?0===e.waterRecord.length?(e.pageArray.fisrtPage=0,e.pageArray.lastPage=0):(e.pageArray.fisrtPage=e.pageArray.total-e.waterRecord.length+1,e.pageArray.lastPage=e.pageArray.total):e.waterRecord.length===e.pageArray.size&&(e.pageArray.fisrtPage=e.pageArray.current*e.waterRecord.length-(e.pageArray.size-1),e.pageArray.lastPage=e.pageArray.current*e.waterRecord.length),e.waterRecord.forEach(function(e,a,t){var r=new Date(t[a].startTime),i=new Date(t[a].endTime);t[a].startTime=r.Format("yyyy-MM-dd hh:mm:ss"),t[a].endTime=i.Format("yyyy-MM-dd hh:mm:ss")}),0===e.waterRecord.length?e.noData=!0:e.noData=!1}).catch(function(e){console.log(e)})},openOnoff:function(e){var a=this,t=sessionStorage.getItem("id");sessionStorage&&sessionStorage.setItem("instructionCode",a.openoffBtn[e].value);var r=sessionStorage.getItem("instructionCode");axios.post("/api/v1/lease/devices/"+t+"/executeInstruction/"+r).then(function(e){sessionStorage.setItem("instructionId",e.data.data);var t=sessionStorage.getItem("instructionId");a.maintain=!1,a.$message({message:"开始执行",type:"success"}),setTimeout(function(){a.onoff=!0},500),function(){function e(s){i++,axios.get("/api/v1/iot/instructions/"+t+"/result").then(function(e){if(i<s){if(null!==e.data.data)return clearTimeout(r),a.onoff=!1,a.$message({message:"执行成功",type:"success"}),!1}else if(i===s){if(null===e.data.data)return clearTimeout(r),a.onoff=!1,a.$message({message:"执行失败",type:"error"}),!1;if(null===e.data.data.errorMsg)return clearTimeout(r),a.onoff=!1,a.$message({message:"执行成功",type:"success"}),!1;clearTimeout(r),a.onoff=!1,a.$message({message:"执行失败",type:"error"})}}).catch(function(e){console.log(e)}),r=setTimeout(function(){e(s)},1e3)}var r=void 0,i=0;return e}()(15)}).catch(function(e){console.log(e)})},handleSizeChange:function(e){this.pageArray.size=e,this.getWaterRecord()},handleCurrentChange:function(e){this.pageArray.current=e,this.getWaterRecord()},getRechargeId:function(e){sessionStorage&&sessionStorage.setItem("rechargeId",e.id),window.location.href="/lease/rechargeOrder/"+e.id},deviceLogs:function(){var e=this,a=sessionStorage.getItem("deviceId");axios.get("/api/v1/devices/"+a+"/deviceLogs",{params:{current:e.deviceLogPage.current,rowCount:e.deviceLogPage.size}}).then(function(a){e.totalElements=a.data.data.totalElements,e.deviceLog=a.data.data.fileList,a.data.data.fileList.forEach(function(a,t,r){null===r[t].createdAt||""===r[t].createdAt?e.deviceLog[t].createdAt="(未知时间)":e.deviceLog[t].createdAt=new Date(r[t].createdAt).Format("yyyy-MM-dd hh:mm:ss"),null===r[t].sourceUri||""===r[t].sourceUri?e.deviceLog[t].sourceUri="javascript:;":e.deviceLog[t].sourceUri=r[t].sourceUri}),0===e.totalElements?(e.moreText="暂无数据",e.moreIcon=!1,e.isBlue=!0,e.isNull=!0):e.deviceLog.length<=4&&(e.moreText="没有了",e.moreIcon=!1,e.isBlue=!0,e.isNull=!0)}).catch(function(e){console.log(e)})},loadMore:function(){var e=this;if(e.deviceLog.length<e.totalElements&&0!==e.totalElements)e.deviceLogPage.current++,axios.get("/api/v1/devices/"+deviceId+"/deviceLogs",{params:{current:e.deviceLogPage.current,rowCount:e.deviceLogPage.size}}).then(function(a){a.data.data.fileList.forEach(function(a,t,r){null===r[t].createdAt||""===r[t].createdAt?r[t].createdAt="(未知时间)":r[t].createdAt=new Date(r[t].createdAt).Format("yyyy-MM-dd hh:mm:ss"),e.deviceLog.push(r[t])}),e.deviceLog.length>=e.totalElements&&(e.moreText="没有了",e.moreIcon=!1,e.isBlue=!0)}).catch(function(e){console.log(e)});else if(e.deviceLog.length>=e.totalElements)return!1},waterFetch:function(e,a){var t=sessionStorage.getItem("id"),r=this,i=[],s=1;axios.get("/api/v1/lease/devices/"+t+"/report",{params:{dateScopeType:e,startDate:a}}).then(function(a){r.waterData=a.data.data,"周"===e?(s=1,r.waterData.forEach(function(e,a,t){i.push(moment(t[a].date).format("dddd"))})):"月"===e?(s=1,r.waterData.forEach(function(e,a,t){i.push(moment(t[a].date).format("MM-DD"))})):"年"===e&&r.waterData.forEach(function(e,a,t){i.push(moment(t[a].date).format("YYYY-MM"))}),r._chart.xAxis[0].update({labels:{step:s,rotation:-45},categories:i});var t=r._chart.series[0],o=r._chart.series[1],n=r._chart.series[2],l=r._chart.series[3],c=[],d=[],u=[],g=[];r.waterData.forEach(function(e,a,t){c.push(t[a].inWaterTds),d.push(t[a].inWaterFlow),u.push(t[a].outWaterTds),g.push(t[a].outWaterFlow)}),t.update({data:c}),o.update({data:d}),n.update({data:u}),l.update({data:g})}).catch(function(e){console.log(e)})},charts:function(){var e=this;$(function(){e._chart=new Highcharts.Chart({chart:{renderTo:"container",events:{load:e.waterFetch("周",new Date)}},title:{text:""},legend:{enabled:!1},xAxis:{crosshair:!0},yAxis:{min:0,title:{text:""}},series:[{name:"净水TDS值",type:"spline",data:[]},{name:"净水量(ml)",type:"column",data:[]},{name:"出水TDS值",type:"spline",data:[]},{name:"出水量(ml)",type:"column",data:[]}],credits:{enabled:!1}})})},changeWater:function(e){var a=this;""===a.waterDate?a.waterFetch(e,new Date):a.waterFetch(e,a.waterDate)},changeWaterDate:function(e){var a=this;a.waterFetch(a.waterRecordBtn,e)},serviceDatas:function(e){return"serviceData"},rechargeDatas:function(e){return"rechargeData"},serviceTableTit:function(){var e=document.getElementsByClassName("serviceData");console.log(e);for(var a=0;a<e.length;a++){var t=e[a].getElementsByClassName("cell");console.log(t),t[0].innerHTML+='<div class="cellTit">进度状态</div>',t[1].innerHTML+='<div class="cellTit">服务类型</div>',t[2].innerHTML+='<div class="cellTit">服务单号</div>',t[3].innerHTML+='<div class="cellTit">服务商</div>',t[4].innerHTML+='<div class="cellTit">客户姓名</div>',t[5].innerHTML+='<div class="cellTit">预约时间</div>',t[6].innerHTML+='<div class="cellTit">创建时间</div>'}},rechargeTableTit:function(){for(var e=document.getElementsByClassName("rechargeData"),a=0;a<e.length;a++)for(var t=e[a].getElementsByClassName("cell"),r=0;r<t.length;r++)t[r].innerHTML+='<div class="cellTit">'+this.rechargeTit[r].label+"</div>"}}});