window.IotDeviceModel=function(t,e){return{init:function(){this._initSelectParts(),this._initDeleteParts(),this._initAddParts();var e=this;t("#btnSave").on("click",function(){!0===t("#iotForm").parsley().validate()&&e.save()})},save:function(){t("body").mask('<i class="fa fa-spinner fa-pulse"></i> 正在保存...');var a=this._getParts();e.ajax.post({url:"/iot/deviceModel/"+t("#entityId").val()+"/save",data:{modelName:t("#modelName").val(),memos:t("#memos").val(),modelParts:JSON.stringify(a)},onSuccess:function(){toast("配置保存成功"),setTimeout(function(){window.location.reload()},1e3)},onFinally:function(){t("body").unmask()}})},_initSelectParts:function(e){e=e||".part-productId",t(e).select2({ajax:{url:"/shop/product/parts/list/select2",processResults:function(e){var a=[];if(0===e.returnCode){var i=e.parts;i.length>0&&t.each(i,function(t,e){a.push({id:e.id,text:e.name+"("+e.itemCode+")"})})}return{results:a}}}}),this._getParts()},_getParts:function(){var e=[];return t.each(t(".part-item"),function(){var a=t(this).find("option:selected").text(),i=a.lastIndexOf("("),r=a.lastIndexOf(")"),s=a.substring(i+1,r);a=a.substring(0,i);var n=t(this).find(".part-productId").val(),o=t(this).find(".part-totalWaterflow").val(),d=t(this).find(".part-orderNo").val();e.push({id:t(this).data("id"),status:t(this).data("status"),productId:n,name:a,code:s,totalWaterflow:o,orderNo:d})}),e},_initDeleteParts:function(){var e=this;t(document).on("click",".part-action-delete",function(){if(1===t(".part-item:visible").length)return void toast("该设备至少需要一个配件信息","error");t(this).closest(".part-item").data("status",9).removeAttr("id").fadeOut(),e._refreshOrderNo()})},_initAddParts:function(){var e=this;t(".part-action-add").on("click",function(){var a=t.templates("#partTpl");t("#partsContainer").append(a.render({})),e._refreshOrderNo();var i="#"+t(".part-item:last").attr("id")+" .part-productId";e._initSelectParts(i)})},_refreshOrderNo:function(){var e=1;t.each(t(".part-item"),function(){9!==t(this).data("status")&&(t(this).find(".part-orderNo").val(e),t(this).attr("id","partItem"+e),e++)})}}}(jQuery,App);