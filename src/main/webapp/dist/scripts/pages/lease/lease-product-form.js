var LeaseProductForm=function(){var e=0,t=null,i=!1;return{init:function(){var e=this;$("#btnSelectProduct").on("click",function(){e.selectProduct()}),new ImagePicker({id:"btnSelectMedias",multiple:!0,onOk:function(e){var t="";$.each(e,function(e,i){t+='<div class="media-items" data-id="'+i.id+'">',t+='    <img src="'+i.url+'!wh100" width="80" height="80"/>',t+='    <i class="fa fa-times-circle media-item-remove"></i>',t+="</div>"}),$("#btnSelectMedias").before(t)}}),$(document).on("click",".media-item-remove",function(){$(this).closest(".media-items").fadeOut("600",function(){$(this).remove()})})},selectProduct:function(){var e=this;new Dlg({id:"selectProductDlg",title:"选择企业产品",url:"/shop/product/selectProducts",width:800,height:500,onLoaded:function(){e._initProductGrid()},onOk:function(){if(null===t)return void toast("请选择产品","error");$("#productName").val(t.name),$("#productConfuseId").val(t.id),$("#productSpecConfuseId").val(""),$("#name").val(t.name),!0===t.multiSpec?($("#productSpecs").empty(),$.each(t.specs,function(e,t){var i='<option value="'+t.id+'">'+t.itemCode;null!==t.specItems&&t.specItems.length>0&&(i+="(",$.each(t.specItems,function(e,t){e>0&&(i+=","),i+=t.name+": "+t.value}),i+=")"),i+="</option>",$("#productSpecs").append(i),0===e&&$("#code").val(t.itemCode)}),$("#productSpecsGroup").show(),$("#productSpecs").off("change").on("change",function(){$("#productSpecConfuseId").val($(this).val())}).trigger("change"),$("#iotForm").parsley().validate(),e._flashWarn()):($("#productSpecs").empty(),$("#productSpecsGroup").hide(),$("#code").val(t.itemCode),$("#productSpecConfuseId").val(null)),this.close()}})},isExist:function(e){$("body").mask('<i class="fa fa-spinner fa-pulse"></i> 正在校验...'),App.ajax.get({url:"/lease/product/isExist",data:{entityId:$("#id").val(),name:$("#name").val(),code:$("#code").val()},onSuccess:function(t){$("body").unmask(),"function"==typeof e&&e.call(this,t)},onFinally:function(){$("body").unmask()}})},submit:function(){return!!i||(this.isExist(function(e){!0===e.isExist?(i=!1,Messenger.warning({title:"重复提示",message:e.errorMsg})):(i=!0,$("#iotForm").submit())}),!1)},_initProductGrid:function(){new BootGrid({id:"product4selectGrid",url:"/shop/product",data:{productType:"CP",deviceType:"I"},selection:!0,multiSelect:!1,rowSelect:!0,rowCount:10,formatters:{productTypeFormatter:function(e,t){return"CP"===t.productType?"I"===t.deviceType?"智能设备":"普通产品":t.productTypeTitle}},onSelected:function(e){t=e[0]}})},_flashWarn:function(){var t=this;e<5?$("#selectSpecWarn").fadeOut(600,function(){$(this).fadeIn(600,function(){e++,t._flashWarn()})}):$("#selectSpecWarn").hide()}}}();