var AuthCode=function(t){var o="/shop/product/authCode",e=null,n={initGrid:function(t,a){e=new BootGrid({id:t,url:o,data:a||{},formatters:{formatSn:function(t,o){return o.authCodeStart+"~"+o.authCodeEnd},productCodeFormatter:function(t,o){return"leaseProduct"===$("#type").val()?o.leaseProductCode:o.itemCode},productNameFormatter:function(t,o){return"leaseProduct"===$("#type").val()?o.leaseProductName:o.product.name},commands:function(t,o){var e='<button type="button" class="btn btn-xs btn-default cmd-qrcode" ';return e+='data-row-id="'+o.id+'"',e+=">打印二维码</button> ",e+=' <button type="button" class="btn btn-xs btn-default cmd-used" data-row-id="'+o.id+'">使用记录</button>'}},onLoaded:function(){$(".cmd-qrcode").off("click").on("click",function(){n.openQRCodeDlg($(this).data("rowId"),a)}),$(".cmd-used").off("click").on("click",function(){n.viewUsed($(this).data("rowId"))})}})},gridReload:function(){null!==e&&e.reload()},openCreateDlg:function(t,e){new Dlg({id:"createAuthCodeDlg",title:"新建产品授权信息",height:300,url:o+"/create",data:t,onOk:function(){if(!0===$("#authCodeForm").parsley().validate()){var t=$("#authCodeForm").serializeObject();if(parseInt(t.codeCount)>1e3)return void toast("每次授权数量不得超于1000","error");var o=this;n.save(t,function(){o.close(),"function"==typeof e&&e.call(this)})}}})},save:function(e,n){$("body").mask('<i class="fa fa-spinner fa-pulse"></i> 正在保存...'),t.ajax.post({url:o+"/-1",data:e,onSuccess:function(t){"function"==typeof n&&n.call(this,t)},onFinally:function(){$("body").unmask()}})},openQRCodeDlg:function(t,e){new Dlg({title:"打印下载二维码",url:o+"/"+t+"/qrcode/toPrint",data:e||{},height:270,onOk:function(){var t=this,o=$.extend({},o,{size:$("#qrcodeSize").val()});n.doPrint($("#authCodeId").val(),o,function(){t.close()})}})},doPrint:function(e,n,a){$("body").mask('<i class="fa fa-spinner fa-pulse"></i> 正在处理...');var d=window.open("/shop/product/authCode/qrcode/predownload","正在下载，请稍候...","_blank");t.ajax.get({url:o+"/"+e+"/qrcode/doPrint",data:n,onSuccess:function(t){"function"==typeof a&&a.call(this,t),setTimeout(function(){d.location=o+"/"+e+"/qrcode/download?qrcodePath="+t.folder},600)},onFail:function(){Messenger.error({title:"错误提示",message:"抱歉，二维码打印失败。"})},onFinally:function(){$("body").unmask()}})},viewUsed:function(t){new Dlg({title:"授权码使用情况",url:o+"/"+t+"/viewUsed",width:800,height:450,onLoaded:function(){new BootGrid({id:"authCodeUsedGrid",url:o+"/"+t+"/viewUsed/page",rowCount:10})}})}};return n}(App);