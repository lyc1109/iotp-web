var ProductForm=function(e){var t=!1,i={init:function(){$("#productCategoryConfuseIds").on("change",function(e){var t=$(this).val(),i=[];if(t.length>3){toast("对不起, 最多可选取三个分类!","error");for(var r=0;r<3;r++)i.push(t[r]);$(this).val(i),$("#productCategoryConfuseIds").trigger("change.select2")}}),$("#productSpecGroupConfuseId").on("change",function(){"-1"!==$(this).val()?(i.renderProductSpec(),$("#productItemCode").removeAttr("data-parsley-required").val(""),$("#productItemCodeFormGroup").hide()):($("#productItemCode").attr("data-parsley-required",!0),$("#productItemCodeFormGroup").show()),i.renderProductSpec()}).trigger("change"),new e({id:"btnCoverImagePicker",onOk:function(e){$("#coverImagePrev").attr("src",e[0].url),$("#coverImagePrev").show(),$("#coverImageConfuseId").val(e[0].id)}}),$(':radio[name="productType"]').on("ifChecked",function(e){"CP"===$(this).val()?($("#deviceType").show(),"I"===$(':checked[name="deviceType"]').val()?($("#iotDeviceInfo").show(),$("#iotDeviceType").attr("data-parsley-required",!0),$("#iotDeviceModel").attr("data-parsley-required",!0)):($("#iotDeviceInfo").hide(),$("#iotDeviceType").removeAttr("data-parsley-required"),$("#iotDeviceModel").removeAttr("data-parsley-required"))):($("#deviceType").hide(),$("#iotDeviceInfo").hide(),$("#iotDeviceType").removeAttr("data-parsley-required"),$("#iotDeviceModel").removeAttr("data-parsley-required"))}),"CP"!==$(':radio[name="productType"]:checked').val()&&($("#deviceType").hide(),$("#iotDeviceInfo").hide()),$(':radio[name="deviceType"]').on("ifChecked",function(e){"I"===$(':checked[name="deviceType"]').val()?($("#iotDeviceInfo").show(),$("#iotDeviceType").attr("data-parsley-required",!0),$("#iotDeviceModel").attr("data-parsley-required",!0)):($("#iotDeviceInfo").hide(),$("#iotDeviceType").removeAttr("data-parsley-required"),$("#iotDeviceModel").removeAttr("data-parsley-required"))}),"I"===$(':checked[name="deviceType"]').val()&&($("#iotDeviceType").attr("data-parsley-required",!0),$("#iotDeviceModel").attr("data-parsley-required",!0)),$("#iotDeviceType").on("change",function(){$("#iotDeviceModel").val(null).trigger("change.select2")}),"I"===$(':checked[name="deviceType"]').val()&&($("#iotDeviceInfo").show(),$("#iotDeviceType").trigger("change")),$("#iotDeviceModel").select2({ajax:{url:"/iot/deviceModel/list",data:function(e){return $.extend(e,{iotDeviceType:$("#iotDeviceType").val()})},processResults:function(e){var t=[];if(0===e.returnCode){var i=e.iotDeviceModels;i.length>0&&$.each(i,function(e,i){t.push({id:i.modelCode,text:i.modelName})})}return{results:t}}}}),""!==$("#iotDeviceModelVal").val()&&$("#iotDeviceModel").append('<option value="'+$("#iotDeviceModelVal").val()+'" selected="selected">'+$("#iotDeviceModelName").val()+"</option>")},renderProductSpec:function(){var t=$("#productSpecGroupConfuseId").val();"-1"===t?($(".product-spec-no").show(),$(".product-spec").hide(),$(".product-spec-container").empty()):($(".product-spec-no").hide(),$(".product-spec-container").load("/shop/product/loadSpec?productId="+$("#_id").val()+"&specGroupId="+t,function(){$(".select-image").each(function(){var t=$(this).attr("id");new e({id:t,onOk:function(e){$("#specCoverImage_"+t).attr("src",e[0].url),$("#specCoverImageId_"+t).val(e[0].id)}})}),$(".cmd-spec-delete").on("click",function(){1===$(".spec-row").length?toast("对不起, 商品至少需要一个规格信息!","error"):$(this).closest(".spec-row").slideUp("slow",function(){$(this).remove()})}),$(".product-spec").show()}))},getSpecs:function(){var e=[];if("-1"!==$("#productSpecGroupConfuseId").val()&&($(".spec-row").each(function(){var t=$(this).find(".spec-item-cover").val(),i=$(this).data("specid"),r=$(this).find(".spec-item-code").val(),o=parseFloat(100*$(this).find(".spec-item-price").val());if(o<0)return Messenger.warning({title:"错误提示",message:"规格价格必须大于0"}),e=!1,!1;if(""===r||""===o)return Messenger.warning({title:"规格必填提示",message:"请填写产品规格信息中的货号以及价格"}),e=!1,!1;var c={productSpecConfuseId:i,coverImageConfuseId:t,itemCode:r,price:o};$(this).find(".spec-item-def").each(function(){var e=$(this).data("specIndex");c["specName0"+e]=$(this).data("specName"),c["specVal0"+e]=$(this).data("specVal")}),e.push(c)}),!1!==e)){if(_.unionBy(e,"itemCode").length!==e.length)return Messenger.warning({title:"货号重复",message:"规格列表中有货号重复，不允许重复添加。"}),e=!1,!1}return e},checkExistItemCode:function(e){var t={productId:$("#_id").val()},i=this.getSpecs();if(!1!==i){if(null!==i&&i.length>0)t.specs=JSON.stringify(i);else{var r=$("#productItemCode").val();if(""===r||0===r.length)return void Messenger.error("请输入商品货号，或者至少添加一个商品规格");t.itemCode=r}$("body").mask('<i class="fa fa-spinner fa-pulse"></i> 正在校验...'),App.ajax.get({url:"/shop/product/existItemCode",data:t,onSuccess:function(t){$("body").unmask(),"function"==typeof e&&(t.specs=i,e.call(this,t))},onFinally:function(){$("body").unmask()}})}},submit:function(){return!!t||(this.checkExistItemCode(function(e){if(!0===e.isExist){var r="";$.each(e.existProducts,function(e,t){""!==r&&(r+=","),r+='<a href="/shop/product/'+t.id+'" target="_blank">'+t.itemCode+"</a>"}),$.each(e.existProductSpecs,function(e,t){""!==r&&(r+=","),r+='<a href="/shop/product/'+t.productId+'" target="_blank">'+t.itemCode+"</a>"}),Messenger.warning({title:"货号重复提醒",html:r}),t=!1}else{t=!0;var o=Math.round(100*$("#dblPrice").val());$("#price").val(o),$("#listPrice").val(o);if(!1===i.getSpecs())return!1;$("#specs").val(JSON.stringify(e.specs)),$("#iotForm").submit()}}),!1)}};return i}(ImagePicker);