var ShopVendorJoinForm=function(e,o,s,n){var i=null,r=0,t=!1,a=!1,c=!1,d="",l="",u={initForm:function(){e("#distpicker").distpicker({placeholder:!1}),e("#province,#city").on("change",function(){0===e("#area").find("option").length?e("#area").hide():e("#area").show()}).trigger("change"),this.initImgUploader(),i=new s("#btnSentSmsCode","#userMobile"),e("#btnSentSmsCode").on("sms.sendSuccess",function(){console.log("验证码发送成功"),l=e("#userMobile").val()}),e("#userMobile").on("keyup blur",function(){var o=/^1[3|4|5|7|8][0-9]{9}$/,s=e(this).val();o.test(s)&&!c&&d!==s&&(e(this).is(":focus")&&e(this).blur(),u.findExistShops(s),e("#contactTelephone").val(s),e("#contactMobile").val(s),e("#contactMobileText").val(s),d=s)}),e("#userLoginPwd,#confirmLoginPwd").on("blur",function(){""!==e("#confirmLoginPwd").val()&&""!==e("#userLoginPwd").val()&&u.confirmPassword()}),e(".cmd-next").on("click",function(){u.nextStep()}),e(".cmd-prev").on("click",function(){u.prevStep()}),e(document).on("click",".cmd-new-shop",function(){e("#shopsContainer").hide(),e("#shopInfos").show(),e(":radio[name=shopId]").prop("checked",!1),t&&e(".cmd-select-shop").closest("div").show()}),e(document).on("click",".cmd-select-shop",function(){e("#shopsContainer").show(),e("#shopInfos").hide(),e(":radio[name=shopId]:first").prop("checked",!0)}),e(".cmd-save").on("click",function(){u.submitForm()})},initImgUploader:function(){new n({id:"btnImageUploader",prefix:"ShopLogo",onComplete:function(o){var s=o.files[0];e("#shopLogo").attr("src",s.path),e("#logoImageId").val(s.id)}}),new n({id:"btnSelectBusinessLicenseImg",onComplete:function(o){var s=o.files[0];e("#businessLicenseImg").attr("src",s.path),e("#businessLicenseImg").closest("div").show(),e("#businessLicenseImgId").val(s.id)}})},findExistShops:function(s){e("body").mask("正在检查服务商信息"),c=!0,o.ajax.get({url:"/shop/vendor/find/exist",data:{mobile:s,factoryShopId:e("#shopFactoryId").val()},onSuccess:function(o){if(o.user?(e("#userId").val(o.user.id),e("#userInfos").hide(),e("#userInfos").find(".control-label").removeClass("required"),e("#userInfos").find(".form-control").removeAttr("data-parsley-required")):(e("#userId").val(""),e("#userInfos").show(),e("#userInfos").find(".control-label").addClass("required"),e("#userInfos").find(".form-control").attr("data-parsley-required",!0)),o.isExist){t=!0;var s=e.templates("#shopTpl");e("#shopsContainer").html(s.render({shops:o.shops})).show(),e(":radio[name=shopId]:first").prop("checked",!0),e("#shopInfos").hide()}else t=!1,e("#shopsContainer").hide(),e("#shopInfos").show()},onFinally:function(){c=!1,setTimeout(function(){e("body").unmask()},1e3)}})},confirmPassword:function(){e("#userLoginPwd").val()!==e("#confirmLoginPwd").val()?e("#confirmLoginPwdError").show():e("#confirmLoginPwdError").hide()},nextStep:function(){if(!(r>=2))if(0===r){var o=e("#userRegisterForm").parsley();if(!0!==o.validate())return;if(""!==l&&l!==e("#userMobile").val())return a=!1,i.reset(),e("#smsCode").val(""),void toast("请重新获取验证码","error");a?(e("#userRegisterForm").hide(),e("#shopVendorForm").fadeIn(),t||(e("#shopsContainer").hide(),e("#shopInfos").show()),r++,e(".step-item").removeClass("active"),e(".step-item").eq(r).addClass("active")):i.checkValidCode(e("#smsCode").val(),function(){a=!0,e("#userRegisterForm").hide(),e("#shopVendorForm").fadeIn(),t||(e("#shopsContainer").hide(),e("#shopInfos").show()),r++,e(".step-item").removeClass("active"),e(".step-item").eq(r).addClass("active")})}else 1===r&&(e("#userRegisterForm").hide(),e("#shopVendorForm").hide(),e("#successTips").show(),r++,e(".step-item").removeClass("active"),e(".step-item").eq(r).addClass("active"))},prevStep:function(){0!==r&&(1===r&&(e("#userRegisterForm").fadeIn(),e("#shopVendorForm").hide()),r--,e(".step-item").removeClass("active"),e(".step-item").eq(r).addClass("active"))},checkIsExistName:function(e,s){o.ajax.get({url:"/shop/shop/isExist",data:{shopName:e},onSuccess:function(e){s.call(this,e.isExist)}})},submitForm:function(){var o="";if(t&&e(":radio[name=shopId]:checked").length>0&&(o=e(":radio[name=shopId]:checked").val()),""===o){if(!0!==e("#shopVendorForm").parsley().validate())return;if(""===e("#logoImageId").val()||null===e("#logoImageId").val())return toast("请选择公司Logo","error"),!1;if(""===e("#businessLicenseImgId").val()||null===e("#businessLicenseImgId").val())return toast("请上传资质文件图片，如营业执照","error"),!1;if(!e("#agreement").is(":checked"))return toast("您必须同意并遵守《品智云服务平台用户服务协议》才可以提交申请哦！","error"),!1;u.checkIsExistName(e("#shopName").val(),function(e){e?Messenger.error("抱歉，该企业名称已存在，请重新填写。"):u.doSubmitForm()})}else u.doSubmitForm()},doSubmitForm:function(){Messenger.confirm("是否确定提交服务商申请?",function(){var s=e("#shopVendorForm").serializeObject();s=e.extend({},s,e("#userRegisterForm").serializeObject()),o.ajax.post({url:"/shop/vendor/join/"+e("#shopId").val()+"/save",data:s,onSuccess:function(){u.nextStep()},onFail:function(e){var o="抱歉，申请注册失败。";e.returnMsg&&null!==e.returnMsg&&(o+="原因："+e.returnMsg),Messenger.error(o)}})})}};return u}(jQuery,App,Sms,Uploader);